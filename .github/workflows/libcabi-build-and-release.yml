name: Build and Release libcabi

on:
  push:
    branches:
      - main
    tags:
      - "v*"
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  RUST_TOOLCHAIN: "1.91.0"
  ANDROID_NDK_VERSION: "27.3.13750724"

jobs:
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    env:
      CC_aarch64_unknown_linux_gnu: aarch64-linux-gnu-gcc
      CXX_aarch64_unknown_linux_gnu: aarch64-linux-gnu-g++
      AR_aarch64_unknown_linux_gnu: aarch64-linux-gnu-ar
      CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc
    defaults:
      run:
        working-directory: c-abi-libp2p
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java (for Android SDK tools)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Install Rust ${{ env.RUST_TOOLCHAIN }}
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            clang \
            gcc-aarch64-linux-gnu \
            gcc-mingw-w64 \
            libc6-dev-arm64-cross \
            lld

      - name: Add cross compilation targets
        run: |
          rustup target add \
            x86_64-unknown-linux-gnu \
            aarch64-unknown-linux-gnu \
            x86_64-pc-windows-gnu \
            aarch64-linux-android

      - name: Install Android NDK
        run: |
          yes | sdkmanager --licenses >/dev/null
          sdkmanager "ndk;${{ env.ANDROID_NDK_VERSION }}"
          echo "ANDROID_NDK_HOME=${ANDROID_SDK_ROOT}/ndk/${{ env.ANDROID_NDK_VERSION }}" >> "${GITHUB_ENV}"

      - name: Install cargo-ndk
        run: cargo install cargo-ndk --locked

      - name: Build Linux (GNU)
        run: cargo build --release --target x86_64-unknown-linux-gnu

      - name: Build Linux (ARM64)
        run: cargo build --release --target aarch64-unknown-linux-gnu

      - name: Build Windows (GNU)
        run: cargo build --release --target x86_64-pc-windows-gnu

      - name: Build Android (arm64-v8a)
        run: cargo ndk -t arm64-v8a build --release

      - name: Run tests
        run: cargo test --release --verbose

      - name: Run E2EE smoke example
        run: cargo run --example e2ee_local_mesh

      - name: Run Python libsignal local mesh smoke
        timeout-minutes: 8
        env:
          PYTHON_BIN: python3
          E2EE_MODE: on
          MESSAGE: hello-libsignal-ci
          MESSAGE_DELAY: "2"
          POST_MESSAGE_WAIT: "5"
        run: bash examples/python/run_local_mesh.sh

      - name: Collect build artifacts
        run: |
          set -euo pipefail
          OUTPUT_DIR=artifacts
          mkdir -p "${OUTPUT_DIR}"

          # Linux x86_64
          cp target/x86_64-unknown-linux-gnu/release/libcabi_rust_libp2p.so \
            "${OUTPUT_DIR}/libcabi_rust_libp2p-linux-x86_64.so" 2>/dev/null || true

          # Linux aarch64
          cp target/aarch64-unknown-linux-gnu/release/libcabi_rust_libp2p.so \
            "${OUTPUT_DIR}/libcabi_rust_libp2p-linux-aarch64.so" 2>/dev/null || true

          # Windows x86_64 (GNU)
          cp target/x86_64-pc-windows-gnu/release/cabi_rust_libp2p.dll \
            "${OUTPUT_DIR}/cabi_rust_libp2p-windows-x86_64.dll" 2>/dev/null || true

          # Android arm64-v8a
          cp target/aarch64-linux-android/release/libcabi_rust_libp2p.so \
            "${OUTPUT_DIR}/libcabi_rust_libp2p-android-arm64-v8a.so" 2>/dev/null || true

          # Header
          cargo build
          cp cabi-rust-libp2p.h "${OUTPUT_DIR}/" 2>/dev/null || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: libcabi-rust-libp2p-${{ github.sha }}
          path: c-abi-libp2p/artifacts/
          if-no-files-found: error

  release:
    name: Release
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: libcabi-rust-libp2p-${{ github.sha }}
          path: artifacts

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/*
          generate_release_notes: true
          overwrite_files: true
